# Архитектура Funnel Discounts App

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                    SHOPIFY STORE                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐ │
│  │   Admin Panel   │    │  Theme Extension │    │  Cart/Checkout │ │
│  │   (Remix App)   │    │   (Liquid)      │    │   (Liquid)  │ │
│  └─────────────────┘    └─────────────────┘    └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
           │                           │                    │
           │                           │                    │
           ▼                           ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    SHOPIFY BACKEND                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐ │
│  │   Metafields    │    │  Discount       │    │   GraphQL   │ │
│  │   (JSON Data)   │    │  Functions      │    │    API      │ │
│  └─────────────────┘    └─────────────────┘    └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Компоненты системы

### 1. Admin Panel (Remix App)

```
┌─────────────────────────────────────────────────────────────┐
│                    Admin Dashboard                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │  Funnel     │  │  Product    │  │  Analytics          │ │
│  │  Manager    │  │  Selector   │  │  Dashboard          │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│           │               │                    │            │
│           ▼               ▼                    ▼            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Shopify GraphQL API                        │ │
│  │         (Create/Read/Update/Delete Funnels)            │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. Theme Extension (Liquid Templates)

```
┌─────────────────────────────────────────────────────────────┐
│                  Theme Extension                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   Blocks        │  │   Snippets      │  │   Assets    │ │
│  │                 │  │                 │  │             │ │
│  │ • discount_     │  │ • funnel-       │  │ • CSS       │ │
│  │   banner.liquid │  │   discount-     │  │ • JS        │ │
│  │                 │  │   banner.liquid │  │ • Images    │ │
│  │ • advanced_     │  │                 │  │             │ │
│  │   discount_     │  │                 │  │             │ │
│  │   banner.liquid │  │                 │  │             │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3. Discount Functions (JavaScript)

```
┌─────────────────────────────────────────────────────────────┐
│                Discount Functions                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              cart_lines_discounts_generate_run.ts      │ │
│  │                                                         │ │
│  │  • Получает данные о воронках из метаполей              │ │
│  │  • Анализирует содержимое корзины                      │ │
│  │  • Вычисляет применимые скидки                         │ │
│  │  • Создает операции скидок                             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Создание воронки

```
Admin Panel → GraphQL API → Metafields → Theme Extension
     │              │            │              │
     ▼              ▼            ▼              ▼
[Создание] → [Сохранение] → [JSON Data] → [Отображение]
```

### 2. Отображение баннера

```
Product Page → Theme Extension → Metafields → Banner Display
     │              │              │              │
     ▼              ▼              ▼              ▼
[Товар] → [Проверка воронки] → [Данные скидок] → [Баннер]
```

### 3. Применение скидок

```
Cart Update → Discount Function → Metafields → Discount Applied
     │              │                │              │
     ▼              ▼                ▼              ▼
[Корзина] → [Анализ товаров] → [Правила скидок] → [Скидка]
```

## Структура данных

### Funnel Object

```json
{
  "id": "funnel_1234567890",
  "name": "Summer Sale Funnel",
  "products": ["gid://shopify/Product/123", "gid://shopify/Product/456"],
  "banner_text": "Special Summer Discount!",
  "discount_settings": {
    "quantity_tiers": [
      {
        "min_quantity": 2,
        "discount_percentage": 10,
        "description": "10% off for 2+ items"
      },
      {
        "min_quantity": 5,
        "discount_percentage": 20,
        "description": "20% off for 5+ items"
      }
    ],
    "max_discount": 20
  },
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:00:00Z"
}
```

### Metafield Structure

```
Namespace: funnel_discounts
Key: funnels
Type: json
Value: [Array of Funnel Objects]
```

## Интеграция с Shopify

### 1. App Installation

- App устанавливается в Shopify Admin
- Создается метаполе для хранения воронок
- Theme Extension добавляется в тему

### 2. Theme Integration

- Блоки добавляются в секции продукта
- Сниппеты встраиваются в шаблоны
- CSS/JS подключаются к теме

### 3. Discount Application

- Discount Function регистрируется в Shopify
- Автоматически применяется к заказам
- Работает с существующими скидками

## Безопасность и производительность

### 1. Безопасность

- Все данные хранятся в Shopify Metafields
- Нет внешних API вызовов
- Валидация данных на уровне приложения

### 2. Производительность

- Кэширование данных в Liquid
- Минимальные GraphQL запросы
- Оптимизированные CSS/JS

### 3. Масштабируемость

- Поддержка множественных воронок
- Гибкая система уровней скидок
- Адаптивный дизайн баннеров
